<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>音韻認識テストアプリ - ホーム</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <header>
    <h1>音韻認識テストアプリ</h1>
  </header>

  <div class="container">
    <nav>
      <div class="nav-links">
        <a href="/">ホーム</a>
        <a href="/word-lists">単語リスト管理</a>
        <a href="/analysis">データ分析</a>
        <a href="/fonts">フォント管理</a>
      </div>
      <a href="/logout" class="logout-btn">ログアウト</a>
    </nav>

    <div class="card">
      <h2>児童の登録</h2>
      <form id="addChildForm">
        <div class="form-grid">
          <div class="form-group form-grid-full">
            <label for="name">名前 *</label>
            <input type="text" id="name" name="name" required>
          </div>
          <div class="form-group">
            <label for="birth_year">生年</label>
            <input type="number" id="birth_year" name="birth_year" placeholder="例: 2010" min="1990" max="2025">
          </div>
          <div class="form-group">
            <label for="birth_month">生月</label>
            <select id="birth_month" name="birth_month">
              <option value="">選択してください</option>
              <option value="1">1月</option>
              <option value="2">2月</option>
              <option value="3">3月</option>
              <option value="4">4月</option>
              <option value="5">5月</option>
              <option value="6">6月</option>
              <option value="7">7月</option>
              <option value="8">8月</option>
              <option value="9">9月</option>
              <option value="10">10月</option>
              <option value="11">11月</option>
              <option value="12">12月</option>
            </select>
          </div>
          <div class="form-group">
            <label for="enrollment_year">入塾年</label>
            <input type="number" id="enrollment_year" name="enrollment_year" placeholder="例: 2024" min="2000" max="2100">
          </div>
          <div class="form-group">
            <label for="enrollment_month">入塾月</label>
            <select id="enrollment_month" name="enrollment_month">
              <option value="">選択してください</option>
              <option value="1">1月</option>
              <option value="2">2月</option>
              <option value="3">3月</option>
              <option value="4">4月</option>
              <option value="5">5月</option>
              <option value="6">6月</option>
              <option value="7">7月</option>
              <option value="8">8月</option>
              <option value="9">9月</option>
              <option value="10">10月</option>
              <option value="11">11月</option>
              <option value="12">12月</option>
            </select>
          </div>
          <div class="form-group form-grid-right">
            <label for="grade">学年 / 年齢（生年月から自動計算されます）</label>
            <select id="grade" name="grade">
              <option value="">選択してください</option>
              <option value="小学1年">小学1年</option>
              <option value="小学2年">小学2年</option>
              <option value="小学3年">小学3年</option>
              <option value="小学4年">小学4年</option>
              <option value="小学5年">小学5年</option>
              <option value="小学6年">小学6年</option>
              <option value="中学1年">中学1年</option>
              <option value="中学2年">中学2年</option>
              <option value="中学3年">中学3年</option>
              <option value="高校1年">高校1年</option>
              <option value="高校2年">高校2年</option>
              <option value="高校3年">高校3年</option>
              <option value="19歳">19歳</option>
              <option value="20歳">20歳</option>
              <option value="21歳">21歳</option>
              <option value="22歳">22歳</option>
              <option value="23歳">23歳</option>
              <option value="24歳">24歳</option>
              <option value="25歳">25歳</option>
              <option value="26歳">26歳</option>
              <option value="27歳">27歳</option>
              <option value="28歳">28歳</option>
              <option value="29歳">29歳</option>
              <option value="30歳">30歳</option>
              <option value="31歳">31歳</option>
              <option value="32歳">32歳</option>
              <option value="33歳">33歳</option>
              <option value="34歳">34歳</option>
              <option value="35歳">35歳</option>
            </select>
          </div>
          <div class="form-group form-grid-full">
            <label for="notes">備考</label>
            <textarea id="notes" name="notes" rows="3"></textarea>
          </div>
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top: 15px;">登録</button>
      </form>
    </div>

    <div class="card">
      <h2>登録されている児童</h2>
      <% if (children.length === 0) { %>
        <p>まだ児童が登録されていません。</p>
      <% } else { %>
        <table>
          <thead>
            <tr>
              <th>名前</th>
              <th>学年</th>
              <th>生年月</th>
              <th>入塾年月</th>
              <th>登録日</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <% children.forEach(child => { %>
              <tr>
                <td><%= child.name %></td>
                <td><%= child.grade || '-' %></td>
                <td><%= child.birth_year && child.birth_month ? child.birth_year + '年' + child.birth_month + '月' : '-' %></td>
                <td><%= child.enrollment_year && child.enrollment_month ? child.enrollment_year + '年' + child.enrollment_month + '月' : '-' %></td>
                <td><%= new Date(child.created_at).toLocaleDateString('ja-JP') %></td>
                <td>
                  <button class="btn btn-success" onclick="selectChildForTest(<%= child.id %>, '<%= child.name %>')">テスト開始</button>
                  <button class="btn btn-danger" onclick="deleteChild(<%= child.id %>)">削除</button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>
  </div>

  <!-- テスト開始用モーダル（シンプル版） -->
  <div id="testModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
      <h2>テストする単語リストを選択</h2>
      <p style="margin: 15px 0;">児童: <strong id="selectedChildName"></strong></p>
      <div id="wordListSelection"></div>
      <div style="margin-top: 20px; text-align: right;">
        <button class="btn btn-secondary" onclick="closeTestModal()">キャンセル</button>
      </div>
    </div>
  </div>

  <script>
    let selectedChildId = null;

    // 生年月から学年または年齢を自動計算する関数
    function calculateGradeFromBirthDate(birthYear, birthMonth) {
      if (!birthYear || !birthMonth) return '';

      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth() + 1; // 0-11を1-12に変換

      // 現在の年度を計算（4月始まり）
      let schoolYear = currentYear;
      if (currentMonth < 4) {
        schoolYear = currentYear - 1;
      }

      // 生まれた年度を計算（4月1日以前生まれは前年度扱い）
      let birthSchoolYear = parseInt(birthYear);
      if (parseInt(birthMonth) < 4) {
        birthSchoolYear = birthYear - 1;
      }

      // 学年年齢を計算（小学1年生 = 6歳）
      const gradeAge = schoolYear - birthSchoolYear;

      // 学年マッピング
      const gradeMap = {
        6: '小学1年',
        7: '小学2年',
        8: '小学3年',
        9: '小学4年',
        10: '小学5年',
        11: '小学6年',
        12: '中学1年',
        13: '中学2年',
        14: '中学3年',
        15: '高校1年',
        16: '高校2年',
        17: '高校3年'
      };

      // 高校3年以降は年齢表示
      if (gradeAge >= 18) {
        return `${gradeAge}歳`;
      }

      return gradeMap[gradeAge] || '';
    }

    // 生年・生月の入力が変更されたら学年を自動設定
    function updateGradeAutomatically() {
      const birthYear = document.getElementById('birth_year').value;
      const birthMonth = document.getElementById('birth_month').value;
      const gradeSelect = document.getElementById('grade');

      const calculatedGrade = calculateGradeFromBirthDate(birthYear, birthMonth);

      if (calculatedGrade) {
        // 計算された学年をセット
        for (let i = 0; i < gradeSelect.options.length; i++) {
          if (gradeSelect.options[i].value === calculatedGrade) {
            gradeSelect.selectedIndex = i;
            break;
          }
        }
      }
    }

    // 生年・生月フィールドにイベントリスナーを追加
    document.getElementById('birth_year').addEventListener('change', updateGradeAutomatically);
    document.getElementById('birth_month').addEventListener('change', updateGradeAutomatically);

    // 児童登録フォーム
    document.getElementById('addChildForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);

      const response = await fetch('/api/children', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        alert('児童を登録しました');
        location.reload();
      }
    });

    // 児童削除
    async function deleteChild(id) {
      if (!confirm('本当に削除しますか？この児童のテスト記録もすべて削除されます。')) {
        return;
      }

      const response = await fetch(`/api/children/${id}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        alert('削除しました');
        location.reload();
      }
    }

    // テスト開始のための児童選択
    async function selectChildForTest(childId, childName) {
      selectedChildId = childId;
      document.getElementById('selectedChildName').textContent = childName;

      // 単語リストを取得して表示
      const response = await fetch('/api/word-lists-simple');
      if (!response.ok) {
        // APIがまだない場合は仮のデータ
        showWordListSelection([
          { id: 1, name: '基本単語セット1', description: 'ひらがな・カタカナの基本単語' }
        ]);
      } else {
        const wordLists = await response.json();
        showWordListSelection(wordLists);
      }

      document.getElementById('testModal').style.display = 'block';
    }

    function showWordListSelection(wordLists) {
      const container = document.getElementById('wordListSelection');
      container.innerHTML = wordLists.map(wl => `
        <div style="padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; background-color: #f9f9f9;" onclick="startTest(${wl.id})">
          <strong>${wl.name}</strong><br>
          <small style="color: #666;">${wl.description || ''}</small>
        </div>
      `).join('');
    }

    function startTest(wordListId) {
      window.location.href = `/test/${selectedChildId}/${wordListId}`;
    }

    function closeTestModal() {
      document.getElementById('testModal').style.display = 'none';
      selectedChildId = null;
    }
  </script>
</body>
</html>
