<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ»æˆç¸¾è¡¨</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
    }
    .report-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 30px;
      text-align: center;
    }
    .print-btn {
      background-color: #9C27B0;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px;
    }
    .print-btn:hover {
      background-color: #7B1FA2;
    }
    @media print {
      nav, .print-btn { display: none; }
      .card { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ»æˆç¸¾è¡¨</h1>
  </header>

  <div class="container">
    <nav>
      <a href="/">ãƒ›ãƒ¼ãƒ </a>
      <a href="/word-lists">å˜èªãƒªã‚¹ãƒˆç®¡ç†</a>
      <a href="/analysis">ãƒ‡ãƒ¼ã‚¿åˆ†æ</a>
      <a href="/fonts">ãƒ•ã‚©ãƒ³ãƒˆç®¡ç†</a>
    </nav>

    <div class="card">
      <h2>å…ç«¥ã‚’é¸æŠ</h2>
      <% if (children.length === 0) { %>
        <p>å…ç«¥ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
      <% } else { %>
        <select id="childSelector" class="form-group" style="width: 100%; padding: 12px; font-size: 16px;">
          <option value="">å…ç«¥ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          <% children.forEach(child => { %>
            <option value="<%= child.id %>" data-name="<%= child.name %>" data-grade="<%= child.grade || '' %>"><%= child.name %><%= child.grade ? ' (' + child.grade + ')' : '' %></option>
          <% }) %>
        </select>
      <% } %>
    </div>

    <div id="statsArea" style="display: none;">

      <div class="report-header">
        <h2 style="margin: 0; font-size: 32px;" id="reportTitle">éŸ³éŸ»èªè­˜ãƒ†ã‚¹ãƒˆ æˆç¸¾è¡¨</h2>
        <p style="margin: 10px 0 0 0; font-size: 18px;" id="reportSubtitle"></p>
        <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;" id="reportDate"></p>
      </div>

      <div style="text-align: center; margin-bottom: 20px;">
        <button class="print-btn" onclick="window.print()">ğŸ“„ å°åˆ·ãƒ»PDFä¿å­˜</button>
      </div>

      <div class="card">
        <h2>ğŸ“Š ç·åˆçµ±è¨ˆ</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <h3 id="totalTests">-</h3>
            <p>ãƒ†ã‚¹ãƒˆå®Ÿæ–½å›æ•°</p>
          </div>
          <div class="stat-card" style="background-color: #e8f5e9;">
            <h3 id="successfulReads" style="color: #388E3C;">-</h3>
            <p>èª­ã‚ãŸå˜èªæ•°</p>
          </div>
          <div class="stat-card" style="background-color: #fff3e0;">
            <h3 id="avgTime" style="color: #F57C00;">-</h3>
            <p>å¹³å‡èª­ã¿æ™‚é–“ï¼ˆç§’ï¼‰</p>
          </div>
          <div class="stat-card" style="background-color: #ffebee;">
            <h3 id="misreadCount" style="color: #D32F2F;">-</h3>
            <p>èª­ã¿é–“é•ã„å›æ•°</p>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card" style="background-color: #e1f5fe;">
            <h3 id="successRate" style="color: #0277BD;">-</h3>
            <p>æ­£ç­”ç‡</p>
          </div>
          <div class="stat-card" style="background-color: #f3e5f5;">
            <h3 id="fastestTime" style="color: #6A1B9A;">-</h3>
            <p>æœ€é€Ÿèª­ã¿æ™‚é–“ï¼ˆç§’ï¼‰</p>
          </div>
          <div class="stat-card" style="background-color: #fce4ec;">
            <h3 id="slowestTime" style="color: #C2185B;">-</h3>
            <p>æœ€é…èª­ã¿æ™‚é–“ï¼ˆç§’ï¼‰</p>
          </div>
          <div class="stat-card" style="background-color: #e8eaf6;">
            <h3 id="testDays" style="color: #3949AB;">-</h3>
            <p>ãƒ†ã‚¹ãƒˆå®Ÿæ–½æ—¥æ•°</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“ˆ æˆç¸¾æ¨ç§»ï¼ˆæ™‚ç³»åˆ—ï¼‰</h2>
        <div class="chart-container">
          <canvas id="progressChart"></canvas>
        </div>
      </div>

      <div class="card">
        <h2>â±ï¸ èª­ã¿æ™‚é–“ã®æ¨ç§»</h2>
        <div class="chart-container">
          <canvas id="timeChart"></canvas>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“Š èª­ã¿æ™‚é–“ã®æ”¹å–„ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆ5å›ç§»å‹•å¹³å‡ï¼‰</h2>
        <div class="chart-container">
          <canvas id="improvementTrendChart"></canvas>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ¯ å˜èªåˆ¥ é€Ÿåº¦æ”¹å–„ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
        <p style="color: #666; margin-bottom: 15px;">å„å˜èªã®åˆå›ã¨æœ€æ–°ã®èª­ã¿æ™‚é–“ã‚’æ¯”è¼ƒï¼ˆ2å›ä»¥ä¸Šãƒ†ã‚¹ãƒˆã—ãŸå˜èªã®ã¿ï¼‰</p>
        <div id="wordImprovementTable"></div>
      </div>

      <div class="card" style="background-color: #fff3e0;">
        <h2>âš ï¸ æ”¹å–„ãŒå¿…è¦ãªå˜èªï¼ˆè¦æ³¨æ„ãƒªã‚¹ãƒˆï¼‰</h2>
        <p style="color: #666; margin-bottom: 15px;">æ”¹å–„ãŒè¦‹ã‚‰ã‚Œãªã„ã€ã¾ãŸã¯èª­ã¿æ™‚é–“ãŒé•·ããªã£ã¦ã„ã‚‹å˜èª</p>
        <div id="needsImprovementTable"></div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="card">
          <h2>âœ… æ­£ç­”ç‡ã®å†…è¨³</h2>
          <div class="chart-container">
            <canvas id="successPieChart"></canvas>
          </div>
        </div>

        <div class="card">
          <h2>ğŸ“š å˜èªãƒªã‚¹ãƒˆåˆ¥æˆç¸¾</h2>
          <div class="chart-container">
            <canvas id="wordListChart"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“‹ è©³ç´°ãƒ†ã‚¹ãƒˆå±¥æ­´</h2>
        <div id="recordsTable"></div>
      </div>
    </div>
  </div>

  <script>
    const childSelector = document.getElementById('childSelector');
    const statsArea = document.getElementById('statsArea');
    let charts = {}; // ã‚°ãƒ©ãƒ•ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿æŒ

    childSelector.addEventListener('change', async (e) => {
      const childId = e.target.value;

      if (!childId) {
        statsArea.style.display = 'none';
        return;
      }

      const selectedOption = e.target.options[e.target.selectedIndex];
      const childName = selectedOption.dataset.name;
      const childGrade = selectedOption.dataset.grade;

      // ãƒ¬ãƒãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
      document.getElementById('reportTitle').textContent = childName + ' ã•ã‚“ã®æˆç¸¾è¡¨';
      document.getElementById('reportSubtitle').textContent = childGrade ? 'ï¼ˆ' + childGrade + 'ï¼‰' : '';
      document.getElementById('reportDate').textContent = 'ä½œæˆæ—¥: ' + new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });

      const response = await fetch('/api/analysis/' + childId);
      const data = await response.json();

      // çµ±è¨ˆè¡¨ç¤º
      document.getElementById('totalTests').textContent = data.stats.total_tests || 0;
      document.getElementById('successfulReads').textContent = data.stats.successful_reads || 0;
      document.getElementById('avgTime').textContent = data.stats.avg_time ? data.stats.avg_time.toFixed(2) : '-';
      document.getElementById('misreadCount').textContent = data.stats.misread_count || 0;

      // è¿½åŠ çµ±è¨ˆ
      const successRate = data.stats.total_tests > 0
        ? ((data.stats.successful_reads / data.stats.total_tests) * 100).toFixed(1)
        : 0;
      document.getElementById('successRate').textContent = successRate + '%';

      // æœ€é€Ÿãƒ»æœ€é…æ™‚é–“ã®è¨ˆç®—
      const times = data.records.filter(r => r.reading_time_seconds).map(r => r.reading_time_seconds);
      document.getElementById('fastestTime').textContent = times.length > 0 ? Math.min(...times).toFixed(2) : '-';
      document.getElementById('slowestTime').textContent = times.length > 0 ? Math.max(...times).toFixed(2) : '-';

      // ãƒ†ã‚¹ãƒˆå®Ÿæ–½æ—¥æ•°
      const uniqueDays = new Set(data.records.map(r => r.test_date.split('T')[0]));
      document.getElementById('testDays').textContent = uniqueDays.size;

      // ã‚°ãƒ©ãƒ•æç”»
      drawCharts(data);

      // ãƒ†ã‚¹ãƒˆå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«
      drawRecordsTable(data.records);

      // æ–°ã—ã„åˆ†ææ©Ÿèƒ½
      drawImprovementAnalysis(data.records);

      statsArea.style.display = 'block';
    });

    function drawCharts(data) {
      // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ã‚’ç ´æ£„
      Object.values(charts).forEach(chart => chart.destroy());
      charts = {};

      // 1. æˆç¸¾æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆæŠ˜ã‚Œç·šï¼‰
      const progressData = data.records.slice().reverse();
      charts.progress = new Chart(document.getElementById('progressChart'), {
        type: 'line',
        data: {
          labels: progressData.map((r, i) => (i + 1) + 'å›ç›®'),
          datasets: [{
            label: 'èª­ã‚ãŸï¼ˆ1ï¼‰/ èª­ã‚ãªã‹ã£ãŸï¼ˆ0ï¼‰',
            data: progressData.map(r => r.could_read),
            borderColor: '#4CAF50',
            backgroundColor: 'rgba(76, 175, 80, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 1,
              ticks: {
                stepSize: 1,
                callback: function(value) {
                  return value === 1 ? 'èª­ã‚ãŸ' : 'èª­ã‚ãªã‹ã£ãŸ';
                }
              }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });

      // 2. èª­ã¿æ™‚é–“ã®æ¨ç§»ï¼ˆæŠ˜ã‚Œç·šï¼‰
      const timeData = progressData.filter(r => r.reading_time_seconds);
      charts.time = new Chart(document.getElementById('timeChart'), {
        type: 'line',
        data: {
          labels: timeData.map((r, i) => (i + 1) + 'å›ç›®'),
          datasets: [{
            label: 'èª­ã¿æ™‚é–“ï¼ˆç§’ï¼‰',
            data: timeData.map(r => r.reading_time_seconds),
            borderColor: '#FF9800',
            backgroundColor: 'rgba(255, 152, 0, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // 2-2. èª­ã¿æ™‚é–“ã®æ”¹å–„ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆ5å›ç§»å‹•å¹³å‡ï¼‰
      if (timeData.length >= 5) {
        const movingAverage = [];
        for (let i = 4; i < timeData.length; i++) {
          const sum = timeData.slice(i - 4, i + 1).reduce((acc, r) => acc + r.reading_time_seconds, 0);
          movingAverage.push(sum / 5);
        }

        charts.improvementTrend = new Chart(document.getElementById('improvementTrendChart'), {
          type: 'line',
          data: {
            labels: movingAverage.map((_, i) => (i + 5) + 'å›ç›®'),
            datasets: [{
              label: '5å›ç§»å‹•å¹³å‡ï¼ˆç§’ï¼‰',
              data: movingAverage,
              borderColor: '#9C27B0',
              backgroundColor: 'rgba(156, 39, 176, 0.1)',
              tension: 0.4,
              fill: true,
              borderWidth: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  afterLabel: function(context) {
                    const index = context.dataIndex;
                    if (index > 0) {
                      const improvement = ((movingAverage[index - 1] - movingAverage[index]) / movingAverage[index - 1] * 100);
                      return improvement > 0
                        ? `å‰å›ã‚ˆã‚Š ${improvement.toFixed(1)}% æ”¹å–„`
                        : `å‰å›ã‚ˆã‚Š ${Math.abs(improvement).toFixed(1)}% æ‚ªåŒ–`;
                    }
                    return '';
                  }
                }
              }
            }
          }
        });
      } else {
        // ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        const canvas = document.getElementById('improvementTrendChart');
        const ctx = canvas.getContext('2d');
        ctx.font = '16px sans-serif';
        ctx.fillStyle = '#999';
        ctx.textAlign = 'center';
        ctx.fillText('5å›ä»¥ä¸Šã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™', canvas.width / 2, canvas.height / 2);
      }

      // 3. æ­£ç­”ç‡ã®å††ã‚°ãƒ©ãƒ•
      const successCount = data.stats.successful_reads || 0;
      const failCount = (data.stats.total_tests || 0) - successCount;
      charts.successPie = new Chart(document.getElementById('successPieChart'), {
        type: 'doughnut',
        data: {
          labels: ['èª­ã‚ãŸ', 'èª­ã‚ãªã‹ã£ãŸ'],
          datasets: [{
            data: [successCount, failCount],
            backgroundColor: ['#4CAF50', '#f44336']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // 4. å˜èªãƒªã‚¹ãƒˆåˆ¥æˆç¸¾ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰
      const wordListStats = {};
      data.records.forEach(r => {
        if (!wordListStats[r.word_list_name]) {
          wordListStats[r.word_list_name] = { total: 0, success: 0 };
        }
        wordListStats[r.word_list_name].total++;
        if (r.could_read) wordListStats[r.word_list_name].success++;
      });

      const wordListLabels = Object.keys(wordListStats);
      const wordListSuccessRates = wordListLabels.map(label =>
        (wordListStats[label].success / wordListStats[label].total * 100).toFixed(1)
      );

      charts.wordList = new Chart(document.getElementById('wordListChart'), {
        type: 'bar',
        data: {
          labels: wordListLabels,
          datasets: [{
            label: 'æ­£ç­”ç‡ï¼ˆ%ï¼‰',
            data: wordListSuccessRates,
            backgroundColor: '#2196F3'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          }
        }
      });
    }

    function drawRecordsTable(records) {
      const recordsTable = document.getElementById('recordsTable');

      if (records.length === 0) {
        recordsTable.innerHTML = '<p>ã¾ã ãƒ†ã‚¹ãƒˆè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }

      let tableHtml = '<table><thead><tr>' +
        '<th>No.</th>' +
        '<th>æ—¥æ™‚</th>' +
        '<th>å˜èªãƒªã‚¹ãƒˆ</th>' +
        '<th>å˜èª</th>' +
        '<th>çµæœ</th>' +
        '<th>èª­ã¿æ™‚é–“ï¼ˆç§’ï¼‰</th>' +
        '<th>èª­ã¿é–“é•ã„</th>' +
        '<th>å‚™è€ƒ</th>' +
        '</tr></thead><tbody>';

      records.forEach((record, index) => {
        const date = new Date(record.test_date);
        const dateStr = date.toLocaleString('ja-JP');
        const result = record.could_read ? 'âœ“ èª­ã‚ãŸ' : 'âœ— èª­ã‚ãªã‹ã£ãŸ';
        const resultStyle = record.could_read ? 'color: green; font-weight: bold;' : 'color: red; font-weight: bold;';

        tableHtml += '<tr>' +
          '<td>' + (records.length - index) + '</td>' +
          '<td>' + dateStr + '</td>' +
          '<td>' + record.word_list_name + '</td>' +
          '<td style="font-weight: bold; font-size: 18px;">' + record.word_text + '</td>' +
          '<td style="' + resultStyle + '">' + result + '</td>' +
          '<td>' + (record.reading_time_seconds ? record.reading_time_seconds.toFixed(2) : '-') + '</td>' +
          '<td>' + (record.misread_as || '-') + '</td>' +
          '<td>' + (record.notes || '-') + '</td>' +
          '</tr>';
      });

      tableHtml += '</tbody></table>';
      recordsTable.innerHTML = tableHtml;
    }

    function drawImprovementAnalysis(records) {
      // å˜èªã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const wordData = {};

      records.forEach(record => {
        if (!record.reading_time_seconds) return;

        if (!wordData[record.word_text]) {
          wordData[record.word_text] = [];
        }
        wordData[record.word_text].push({
          time: record.reading_time_seconds,
          date: record.test_date,
          could_read: record.could_read
        });
      });

      // å„å˜èªã®æ”¹å–„åº¦ã‚’è¨ˆç®—ï¼ˆ2å›ä»¥ä¸Šãƒ†ã‚¹ãƒˆã—ãŸå˜èªã®ã¿ï¼‰
      const improvements = [];
      Object.keys(wordData).forEach(word => {
        const tests = wordData[word];
        if (tests.length >= 2) {
          // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
          tests.sort((a, b) => new Date(a.date) - new Date(b.date));

          const firstTime = tests[0].time;
          const lastTime = tests[tests.length - 1].time;
          const improvementPercent = ((firstTime - lastTime) / firstTime * 100);
          const avgTime = tests.reduce((sum, t) => sum + t.time, 0) / tests.length;
          const successRate = tests.filter(t => t.could_read).length / tests.length * 100;

          improvements.push({
            word,
            firstTime,
            lastTime,
            improvementPercent,
            improvementSeconds: firstTime - lastTime,
            testCount: tests.length,
            avgTime,
            successRate
          });
        }
      });

      // æ”¹å–„åº¦ã§ã‚½ãƒ¼ãƒˆï¼ˆæ”¹å–„ãŒå¤§ãã„é †ï¼‰
      improvements.sort((a, b) => b.improvementPercent - a.improvementPercent);

      // å˜èªåˆ¥æ”¹å–„ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
      drawWordImprovementTable(improvements);

      // æ”¹å–„ãŒå¿…è¦ãªå˜èªï¼ˆæ”¹å–„åº¦ãŒä½ã„ã€ã¾ãŸã¯æ‚ªåŒ–ã—ã¦ã„ã‚‹ï¼‰
      const needsImprovement = improvements.filter(w => w.improvementPercent < 10).slice(0, 10);
      drawNeedsImprovementTable(needsImprovement);
    }

    function drawWordImprovementTable(improvements) {
      const container = document.getElementById('wordImprovementTable');

      if (improvements.length === 0) {
        container.innerHTML = '<p style="color: #999;">2å›ä»¥ä¸Šãƒ†ã‚¹ãƒˆã—ãŸå˜èªãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }

      let tableHtml = '<table><thead><tr>' +
        '<th>é †ä½</th>' +
        '<th>å˜èª</th>' +
        '<th>åˆå›ï¼ˆç§’ï¼‰</th>' +
        '<th>æœ€æ–°ï¼ˆç§’ï¼‰</th>' +
        '<th>æ”¹å–„åº¦</th>' +
        '<th>çŸ­ç¸®æ™‚é–“</th>' +
        '<th>ãƒ†ã‚¹ãƒˆå›æ•°</th>' +
        '<th>å¹³å‡æ™‚é–“</th>' +
        '<th>æ­£ç­”ç‡</th>' +
        '</tr></thead><tbody>';

      improvements.forEach((item, index) => {
        const improvementStyle = item.improvementPercent > 0
          ? 'color: green; font-weight: bold;'
          : 'color: red; font-weight: bold;';

        const improvementText = item.improvementPercent > 0
          ? `â†“ ${item.improvementPercent.toFixed(1)}%`
          : `â†‘ ${Math.abs(item.improvementPercent).toFixed(1)}%`;

        const shortenText = item.improvementSeconds > 0
          ? `âˆ’${item.improvementSeconds.toFixed(2)}ç§’`
          : `+${Math.abs(item.improvementSeconds).toFixed(2)}ç§’`;

        tableHtml += '<tr>' +
          '<td>' + (index + 1) + '</td>' +
          '<td style="font-weight: bold; font-size: 16px;">' + item.word + '</td>' +
          '<td>' + item.firstTime.toFixed(2) + '</td>' +
          '<td>' + item.lastTime.toFixed(2) + '</td>' +
          '<td style="' + improvementStyle + '">' + improvementText + '</td>' +
          '<td style="' + improvementStyle + '">' + shortenText + '</td>' +
          '<td>' + item.testCount + '</td>' +
          '<td>' + item.avgTime.toFixed(2) + '</td>' +
          '<td>' + item.successRate.toFixed(0) + '%</td>' +
          '</tr>';
      });

      tableHtml += '</tbody></table>';
      container.innerHTML = tableHtml;
    }

    function drawNeedsImprovementTable(needsImprovement) {
      const container = document.getElementById('needsImprovementTable');

      if (needsImprovement.length === 0) {
        container.innerHTML = '<p style="color: green; font-weight: bold;">âœ“ ã™ã¹ã¦ã®å˜èªã§è‰¯å¥½ãªæ”¹å–„ãŒè¦‹ã‚‰ã‚Œã¾ã™ï¼</p>';
        return;
      }

      let tableHtml = '<table><thead><tr>' +
        '<th>å˜èª</th>' +
        '<th>çŠ¶æ³</th>' +
        '<th>åˆå›ï¼ˆç§’ï¼‰</th>' +
        '<th>æœ€æ–°ï¼ˆç§’ï¼‰</th>' +
        '<th>å¤‰åŒ–</th>' +
        '<th>ãƒ†ã‚¹ãƒˆå›æ•°</th>' +
        '<th>æ­£ç­”ç‡</th>' +
        '<th>æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>' +
        '</tr></thead><tbody>';

      needsImprovement.forEach(item => {
        let status, statusStyle, action;

        if (item.improvementPercent < -10) {
          status = 'âš ï¸ æ‚ªåŒ–';
          statusStyle = 'background-color: #ffebee; color: #c62828; font-weight: bold;';
          action = 'é‡ç‚¹çš„ãªç·´ç¿’ãŒå¿…è¦';
        } else if (item.improvementPercent < 0) {
          status = 'âš ï¸ ã‚ãšã‹ã«æ‚ªåŒ–';
          statusStyle = 'background-color: #fff3e0; color: #e65100; font-weight: bold;';
          action = 'è¿½åŠ ç·´ç¿’ã‚’æ¨å¥¨';
        } else if (item.improvementPercent < 5) {
          status = 'â–³ ã»ã¼å¤‰åŒ–ãªã—';
          statusStyle = 'background-color: #fffde7; color: #f57f17;';
          action = 'ç¶™ç¶šçš„ãªç·´ç¿’';
        } else {
          status = 'â–³ ã‚ãšã‹ã«æ”¹å–„';
          statusStyle = 'background-color: #f1f8e9; color: #558b2f;';
          action = 'ã•ã‚‰ãªã‚‹ç·´ç¿’';
        }

        const changeText = item.improvementPercent > 0
          ? `${item.improvementPercent.toFixed(1)}% æ”¹å–„`
          : `${Math.abs(item.improvementPercent).toFixed(1)}% æ‚ªåŒ–`;

        tableHtml += '<tr>' +
          '<td style="font-weight: bold; font-size: 16px;">' + item.word + '</td>' +
          '<td style="' + statusStyle + '">' + status + '</td>' +
          '<td>' + item.firstTime.toFixed(2) + '</td>' +
          '<td>' + item.lastTime.toFixed(2) + '</td>' +
          '<td>' + changeText + '</td>' +
          '<td>' + item.testCount + '</td>' +
          '<td>' + item.successRate.toFixed(0) + '%</td>' +
          '<td>' + action + '</td>' +
          '</tr>';
      });

      tableHtml += '</tbody></table>';
      container.innerHTML = tableHtml;
    }
  </script>
</body>
</html>
