<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>単語リスト管理</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <header>
    <h1>単語リスト管理</h1>
    <div style="position: absolute; top: 10px; right: 20px; font-size: 12px; color: rgba(255,255,255,0.7);">
      <%= commitHash %>
    </div>
  </header>

  <div class="container">
    <nav>
      <div class="nav-links">
        <a href="/">ホーム</a>
        <a href="/word-lists">単語リスト管理</a>
        <a href="/analysis">データ分析</a>
        <a href="/fonts">フォント管理</a>
      </div>
      <a href="/logout" class="logout-btn">ログアウト</a>
    </nav>

    <div class="card">
      <h2>新しい単語リストを作成</h2>
      <form id="addWordListForm">
        <div class="form-group">
          <label for="name">リスト名 *</label>
          <input type="text" id="name" name="name" required>
        </div>
        <div class="form-group">
          <label for="description">説明</label>
          <textarea id="description" name="description" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">作成</button>
      </form>
    </div>

    <div class="card">
      <h2>単語リスト一覧</h2>
      <% if (wordLists.length === 0) { %>
        <p>まだ単語リストがありません。</p>
      <% } else { %>
        <% wordLists.forEach(wl => { %>
          <div class="list-item" id="list-item-<%= wl.id %>" style="display: block;">
            <div style="flex: 1;">
              <div id="view-<%= wl.id %>">
                <strong><%= wl.name %></strong><br>
                <small style="color: #666;"><%= wl.description || '' %></small>
              </div>
              <div id="edit-form-<%= wl.id %>" style="display: none;">
                <div class="form-group" style="margin-bottom: 10px;">
                  <label for="edit-name-<%= wl.id %>">リスト名 *</label>
                  <input type="text" id="edit-name-<%= wl.id %>" value="<%= wl.name %>" required style="width: 100%; padding: 8px; border: 1px solid #d0d0d0; border-radius: 3px;">
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                  <label for="edit-description-<%= wl.id %>">説明</label>
                  <textarea id="edit-description-<%= wl.id %>" rows="2" style="width: 100%; padding: 8px; border: 1px solid #d0d0d0; border-radius: 3px;"><%= wl.description || '' %></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                  <button onclick="saveWordList(<%= wl.id %>)" class="btn btn-primary">保存</button>
                  <button onclick="cancelEdit(<%= wl.id %>)" class="btn btn-secondary">キャンセル</button>
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 10px;">
              <button onclick="toggleEdit(<%= wl.id %>)" id="edit-btn-<%= wl.id %>" class="btn btn-secondary">名前・説明編集</button>
              <a href="/word-lists/<%= wl.id %>" class="btn btn-primary">単語編集</a>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>

    <div class="card">
      <h2>管理機能</h2>
      <p style="color: #666; margin-bottom: 15px;">
        すべての単語リストを削除してデフォルトの単語リスト（em, tad, pev, ret, hame, flate, drap, wick）に置き換えます。<br>
        <strong style="color: #f44336;">※ 既存のテスト記録は保持されますが、単語リストとの関連が失われる可能性があります。</strong>
      </p>
      <button onclick="resetWordLists()" class="btn btn-danger">単語リストをリセット</button>
    </div>
  </div>

  <script>
    document.getElementById('addWordListForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);

      const response = await fetch('/api/word-lists', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        alert('単語リストを作成しました');
        location.reload();
      }
    });

    function toggleEdit(id) {
      const viewDiv = document.getElementById('view-' + id);
      const editDiv = document.getElementById('edit-form-' + id);
      const editBtn = document.getElementById('edit-btn-' + id);

      if (editDiv.style.display === 'none') {
        viewDiv.style.display = 'none';
        editDiv.style.display = 'block';
        editBtn.textContent = '編集中...';
        editBtn.disabled = true;
      } else {
        viewDiv.style.display = 'block';
        editDiv.style.display = 'none';
        editBtn.textContent = '名前・説明編集';
        editBtn.disabled = false;
      }
    }

    function cancelEdit(id) {
      const viewDiv = document.getElementById('view-' + id);
      const editDiv = document.getElementById('edit-form-' + id);
      const editBtn = document.getElementById('edit-btn-' + id);

      viewDiv.style.display = 'block';
      editDiv.style.display = 'none';
      editBtn.textContent = '名前・説明編集';
      editBtn.disabled = false;
    }

    async function saveWordList(id) {
      const name = document.getElementById('edit-name-' + id).value;
      const description = document.getElementById('edit-description-' + id).value;

      if (!name || name.trim() === '') {
        alert('リスト名を入力してください');
        return;
      }

      const response = await fetch('/api/word-lists/' + id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, description })
      });

      if (response.ok) {
        alert('単語リストを更新しました');
        location.reload();
      } else {
        const result = await response.json();
        alert('エラー: ' + (result.message || '更新に失敗しました'));
      }
    }

    async function resetWordLists() {
      if (!confirm('本当にすべての単語リストを削除してリセットしますか？\n\nこの操作は取り消せません。')) {
        return;
      }

      const password = prompt('パスワードを入力してください:');
      if (!password) {
        return;
      }

      try {
        const response = await fetch('/api/admin/reset-word-lists', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const result = await response.json();

        if (response.ok) {
          alert(`成功: ${result.message}\n単語数: ${result.wordCount}`);
          location.reload();
        } else {
          alert(`エラー: ${result.message}`);
        }
      } catch (error) {
        alert('エラーが発生しました: ' + error.message);
      }
    }
  </script>
</body>
</html>
