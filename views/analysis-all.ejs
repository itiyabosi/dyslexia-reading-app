<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…¨ä½“çµ±åˆåˆ†æ</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .print-btn {
      background-color: #9C27B0;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px;
    }
    .print-btn:hover {
      background-color: #7B1FA2;
    }
    @media print {
      nav, .print-btn { display: none; }
      .card { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“ˆ å…¨ä½“çµ±åˆåˆ†æ</h1>
    <div style="position: absolute; top: 10px; right: 20px; font-size: 12px; color: rgba(255,255,255,0.7);">
      <%= commitHash %>
    </div>
  </header>

  <div class="container">
    <nav>
      <div class="nav-links">
        <a href="/">ãƒ›ãƒ¼ãƒ </a>
        <a href="/word-lists">å˜èªãƒªã‚¹ãƒˆç®¡ç†</a>
        <a href="/analysis">å€‹åˆ¥å…ç«¥åˆ†æ</a>
        <a href="/analysis-all">çµ±åˆåˆ†æ</a>
        <a href="/fonts">ãƒ•ã‚©ãƒ³ãƒˆç®¡ç†</a>
      </div>
      <a href="/logout" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </nav>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">ğŸ“Š å…¨ä½“çµ±è¨ˆ</h2>
        <div>
          <button class="print-btn" onclick="window.print()">ğŸ“„ å°åˆ·ãƒ»PDFä¿å­˜</button>
          <button class="btn btn-success" onclick="exportAllToCSV()">ğŸ“Š CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        </div>
      </div>

      <div id="overallStatsContainer">
        <p style="text-align: center; color: #666;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
      </div>
    </div>
  </div>

  <script>
    let allAnalysisData = null; // çµ±åˆåˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ

    // çµ±åˆåˆ†æãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨è¡¨ç¤º
    async function loadOverallAnalysis() {
      try {
        const response = await fetch('/api/analysis-all');
        const data = await response.json();
        allAnalysisData = data;

        // å…¨ä½“çµ±è¨ˆã®è¡¨ç¤º
        const overallStats = data.overallStats;
        const successRate = overallStats.total_tests > 0
          ? ((overallStats.successful_reads / overallStats.total_tests) * 100).toFixed(1)
          : 0;

        let html = '<div class="stats-grid">';
        html += `<div class="stat-card"><h3>${overallStats.total_tests || 0}</h3><p>ç·ãƒ†ã‚¹ãƒˆæ•°</p></div>`;
        html += `<div class="stat-card" style="background-color: #e8f5e9;"><h3 style="color: #388E3C;">${overallStats.successful_reads || 0}</h3><p>èª­ã‚ãŸå›æ•°</p></div>`;
        html += `<div class="stat-card"><h3>${successRate}%</h3><p>å…¨ä½“æˆåŠŸç‡</p></div>`;
        html += `<div class="stat-card" style="background-color: #fff3e0;"><h3 style="color: #F57C00;">${overallStats.avg_time ? overallStats.avg_time.toFixed(2) : '-'}</h3><p>å¹³å‡èª­ã¿æ™‚é–“ï¼ˆç§’ï¼‰</p></div>`;
        html += `<div class="stat-card"><h3>${overallStats.total_children || 0}</h3><p>ç™»éŒ²å…ç«¥æ•°</p></div>`;
        html += `<div class="stat-card"><h3>${overallStats.test_days || 0}</h3><p>ãƒ†ã‚¹ãƒˆå®Ÿæ–½æ—¥æ•°</p></div>`;
        html += '</div>';

        // å…ç«¥åˆ¥çµ±è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«
        html += '<div class="card" style="margin-top: 20px;"><h3>ğŸ§’ å…ç«¥åˆ¥çµ±è¨ˆ</h3>';
        if (data.childrenStats && data.childrenStats.length > 0) {
          html += '<table><thead><tr><th>åå‰</th><th>å­¦å¹´</th><th>ãƒ†ã‚¹ãƒˆæ•°</th><th>æˆåŠŸæ•°</th><th>æˆåŠŸç‡</th><th>å¹³å‡æ™‚é–“ï¼ˆç§’ï¼‰</th><th>é–“é•ã„æ•°</th><th>åˆå›ãƒ†ã‚¹ãƒˆ</th><th>æœ€çµ‚ãƒ†ã‚¹ãƒˆ</th></tr></thead><tbody>';
          data.childrenStats.forEach(child => {
            const childSuccessRate = child.total_tests > 0 ? ((child.successful_reads / child.total_tests) * 100).toFixed(1) : 0;
            const avgTime = child.avg_time ? parseFloat(child.avg_time).toFixed(2) : '-';
            const firstTest = child.first_test_date ? new Date(child.first_test_date).toLocaleDateString('ja-JP') : '-';
            const lastTest = child.last_test_date ? new Date(child.last_test_date).toLocaleDateString('ja-JP') : '-';
            html += `<tr>`;
            html += `<td>${child.name}</td>`;
            html += `<td>${child.grade || '-'}</td>`;
            html += `<td>${child.total_tests || 0}</td>`;
            html += `<td>${child.successful_reads || 0}</td>`;
            html += `<td>${childSuccessRate}%</td>`;
            html += `<td>${avgTime}</td>`;
            html += `<td>${child.misread_count || 0}</td>`;
            html += `<td>${firstTest}</td>`;
            html += `<td>${lastTest}</td>`;
            html += `</tr>`;
          });
          html += '</tbody></table>';
        } else {
          html += '<p style="color: #666;">å…ç«¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        }
        html += '</div>';

        // å˜èªåˆ¥çµ±è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«
        html += '<div class="card" style="margin-top: 20px;"><h3>ğŸ“ å˜èªåˆ¥çµ±è¨ˆ</h3>';
        if (data.wordStats && data.wordStats.length > 0) {
          html += '<table><thead><tr><th>å˜èª</th><th>å˜èªãƒªã‚¹ãƒˆ</th><th>ãƒ†ã‚¹ãƒˆæ•°</th><th>æˆåŠŸæ•°</th><th>æˆåŠŸç‡</th><th>å¹³å‡æ™‚é–“ï¼ˆç§’ï¼‰</th><th>é–“é•ã„æ•°</th></tr></thead><tbody>';
          data.wordStats.forEach(word => {
            const wordSuccessRate = word.total_tests > 0 ? ((word.successful_reads / word.total_tests) * 100).toFixed(1) : 0;
            const avgTime = word.avg_time ? parseFloat(word.avg_time).toFixed(2) : '-';
            html += `<tr>`;
            html += `<td><strong>${word.word_text}</strong></td>`;
            html += `<td>${word.word_list_name || '-'}</td>`;
            html += `<td>${word.total_tests || 0}</td>`;
            html += `<td>${word.successful_reads || 0}</td>`;
            html += `<td>${wordSuccessRate}%</td>`;
            html += `<td>${avgTime}</td>`;
            html += `<td>${word.misread_count || 0}</td>`;
            html += `</tr>`;
          });
          html += '</tbody></table>';
        } else {
          html += '<p style="color: #666;">å˜èªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        }
        html += '</div>';

        // ãƒ•ã‚©ãƒ³ãƒˆåˆ¥çµ±è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«
        html += '<div class="card" style="margin-top: 20px;"><h3>ğŸ”¤ ãƒ•ã‚©ãƒ³ãƒˆåˆ¥çµ±è¨ˆ</h3>';
        if (data.fontStats && data.fontStats.length > 0) {
          html += '<table><thead><tr><th>ãƒ•ã‚©ãƒ³ãƒˆå</th><th>ç¨®é¡</th><th>ãƒ†ã‚¹ãƒˆæ•°</th><th>æˆåŠŸæ•°</th><th>æˆåŠŸç‡</th><th>å¹³å‡æ™‚é–“ï¼ˆç§’ï¼‰</th></tr></thead><tbody>';
          data.fontStats.forEach(font => {
            const fontSuccessRate = font.total_tests > 0 ? ((font.successful_reads / font.total_tests) * 100).toFixed(1) : 0;
            const avgTime = font.avg_time ? parseFloat(font.avg_time).toFixed(2) : '-';
            html += `<tr>`;
            html += `<td>${font.font_name}</td>`;
            html += `<td>${font.font_type}</td>`;
            html += `<td>${font.total_tests || 0}</td>`;
            html += `<td>${font.successful_reads || 0}</td>`;
            html += `<td>${fontSuccessRate}%</td>`;
            html += `<td>${avgTime}</td>`;
            html += `</tr>`;
          });
          html += '</tbody></table>';
        } else {
          html += '<p style="color: #666;">ãƒ•ã‚©ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        }
        html += '</div>';

        // æ—¥åˆ¥ãƒ†ã‚¹ãƒˆæ¨ç§»ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆéå»30æ—¥ï¼‰
        if (data.dailyStats && data.dailyStats.length > 0) {
          html += '<div class="card" style="margin-top: 20px;"><h3>ğŸ“… æ—¥åˆ¥ãƒ†ã‚¹ãƒˆæ¨ç§»ï¼ˆéå»30æ—¥ï¼‰</h3>';
          html += '<table><thead><tr><th>æ—¥ä»˜</th><th>ãƒ†ã‚¹ãƒˆæ•°</th><th>æˆåŠŸæ•°</th><th>æˆåŠŸç‡</th><th>å¹³å‡æ™‚é–“ï¼ˆç§’ï¼‰</th></tr></thead><tbody>';
          data.dailyStats.forEach(day => {
            const dailySuccessRate = day.total_tests > 0 ? ((day.successful_reads / day.total_tests) * 100).toFixed(1) : 0;
            const avgTime = day.avg_time ? parseFloat(day.avg_time).toFixed(2) : '-';
            const testDate = new Date(day.test_date).toLocaleDateString('ja-JP');
            html += `<tr>`;
            html += `<td>${testDate}</td>`;
            html += `<td>${day.total_tests || 0}</td>`;
            html += `<td>${day.successful_reads || 0}</td>`;
            html += `<td>${dailySuccessRate}%</td>`;
            html += `<td>${avgTime}</td>`;
            html += `</tr>`;
          });
          html += '</tbody></table></div>';
        }

        document.getElementById('overallStatsContainer').innerHTML = html;
      } catch (error) {
        console.error('çµ±åˆåˆ†æãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('overallStatsContainer').innerHTML = '<p style="color: red;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
      }
    }

    // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–¢æ•°ï¼ˆçµ±åˆãƒ‡ãƒ¼ã‚¿ï¼‰
    function exportAllToCSV() {
      if (!allAnalysisData) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const date = new Date().toISOString().split('T')[0];
      let csv = '\uFEFF'; // BOM for Excel UTF-8 support

      // å…¨ä½“çµ±è¨ˆ
      const overallStats = allAnalysisData.overallStats;
      const overallSuccessRate = overallStats.total_tests > 0 ? ((overallStats.successful_reads / overallStats.total_tests) * 100).toFixed(1) : 0;
      csv += '=== å…¨ä½“çµ±è¨ˆ ===\n';
      csv += `ç·ãƒ†ã‚¹ãƒˆæ•°,${overallStats.total_tests || 0}\n`;
      csv += `èª­ã‚ãŸå›æ•°,${overallStats.successful_reads || 0}\n`;
      csv += `å…¨ä½“æˆåŠŸç‡(%),${overallSuccessRate}\n`;
      csv += `å¹³å‡èª­ã¿æ™‚é–“(ç§’),${overallStats.avg_time ? overallStats.avg_time.toFixed(2) : '-'}\n`;
      csv += `ç™»éŒ²å…ç«¥æ•°,${overallStats.total_children || 0}\n`;
      csv += `ãƒ†ã‚¹ãƒˆå®Ÿæ–½æ—¥æ•°,${overallStats.test_days || 0}\n`;

      // å…ç«¥åˆ¥çµ±è¨ˆ
      csv += '\n=== å…ç«¥åˆ¥çµ±è¨ˆ ===\n';
      csv += 'åå‰,å­¦å¹´,ãƒ†ã‚¹ãƒˆæ•°,æˆåŠŸæ•°,æˆåŠŸç‡(%),å¹³å‡æ™‚é–“(ç§’),é–“é•ã„æ•°,åˆå›ãƒ†ã‚¹ãƒˆ,æœ€çµ‚ãƒ†ã‚¹ãƒˆ\n';
      allAnalysisData.childrenStats.forEach(child => {
        const successRate = child.total_tests > 0 ? ((child.successful_reads / child.total_tests) * 100).toFixed(1) : 0;
        const avgTime = child.avg_time ? parseFloat(child.avg_time).toFixed(2) : '-';
        const firstTest = child.first_test_date ? new Date(child.first_test_date).toLocaleDateString('ja-JP') : '-';
        const lastTest = child.last_test_date ? new Date(child.last_test_date).toLocaleDateString('ja-JP') : '-';
        csv += `${child.name},${child.grade || '-'},${child.total_tests || 0},${child.successful_reads || 0},${successRate},${avgTime},${child.misread_count || 0},${firstTest},${lastTest}\n`;
      });

      csv += '\n=== å˜èªåˆ¥çµ±è¨ˆ ===\n';
      csv += 'å˜èª,å˜èªãƒªã‚¹ãƒˆ,ãƒ†ã‚¹ãƒˆæ•°,æˆåŠŸæ•°,æˆåŠŸç‡(%),å¹³å‡æ™‚é–“(ç§’),é–“é•ã„æ•°\n';
      allAnalysisData.wordStats.forEach(word => {
        const successRate = word.total_tests > 0 ? ((word.successful_reads / word.total_tests) * 100).toFixed(1) : 0;
        const avgTime = word.avg_time ? parseFloat(word.avg_time).toFixed(2) : '-';
        csv += `${word.word_text},${word.word_list_name || '-'},${word.total_tests || 0},${word.successful_reads || 0},${successRate},${avgTime},${word.misread_count || 0}\n`;
      });

      csv += '\n=== ãƒ•ã‚©ãƒ³ãƒˆåˆ¥çµ±è¨ˆ ===\n';
      csv += 'ãƒ•ã‚©ãƒ³ãƒˆå,ç¨®é¡,ãƒ†ã‚¹ãƒˆæ•°,æˆåŠŸæ•°,æˆåŠŸç‡(%),å¹³å‡æ™‚é–“(ç§’)\n';
      allAnalysisData.fontStats.forEach(font => {
        const successRate = font.total_tests > 0 ? ((font.successful_reads / font.total_tests) * 100).toFixed(1) : 0;
        const avgTime = font.avg_time ? parseFloat(font.avg_time).toFixed(2) : '-';
        csv += `${font.font_name},${font.font_type},${font.total_tests || 0},${font.successful_reads || 0},${successRate},${avgTime}\n`;
      });

      if (allAnalysisData.dailyStats && allAnalysisData.dailyStats.length > 0) {
        csv += '\n=== æ—¥åˆ¥ãƒ†ã‚¹ãƒˆæ¨ç§»ï¼ˆéå»30æ—¥ï¼‰ ===\n';
        csv += 'æ—¥ä»˜,ãƒ†ã‚¹ãƒˆæ•°,æˆåŠŸæ•°,æˆåŠŸç‡(%),å¹³å‡æ™‚é–“(ç§’)\n';
        allAnalysisData.dailyStats.forEach(day => {
          const successRate = day.total_tests > 0 ? ((day.successful_reads / day.total_tests) * 100).toFixed(1) : 0;
          const avgTime = day.avg_time ? parseFloat(day.avg_time).toFixed(2) : '-';
          const testDate = new Date(day.test_date).toLocaleDateString('ja-JP');
          csv += `${testDate},${day.total_tests || 0},${day.successful_reads || 0},${successRate},${avgTime}\n`;
        });
      }

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `çµ±åˆåˆ†æ_${date}.csv`;
      link.click();
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«çµ±åˆåˆ†æãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    loadOverallAnalysis();
  </script>
</body>
</html>
